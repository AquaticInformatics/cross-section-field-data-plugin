# Stage/Discharge Field Data Plugin

The StageDischarge field data plugin is a customer-installable plugin for AQTS 2017.4+.
It parses CSV files and imports stage/discharge activities, and parameter readings.

## Installation

Use the [FieldDataPluginTool](https://github.com/AquaticInformatics/examples/tree/master/TimeSeries/PublicApis/FieldDataPlugins/FieldDataPluginTool) to install the `StageDischarge.plugin` file on your AQTS app server.

## CSV File format

The CSV file format supported by the plugin allows for flexible combinations of field data to be imported.

The supported CSV file has the following text rules:
- UTF-8 encoding is assumed. The UTF-8 byte-order-mark of (`0xEF, 0xBB, 0xBF`) at the start of the file is completely optional.
- Lines starting with a `#` as the first non-whitespace character are ignored as comment-lines.
- Completely blank lines are ignored.
- The header line (line 5 in the [example file](#example-file) below) can be repeated any number of times, and will always be ignored. The field names in the header line must match the English field names listed in the table below.
- Leading/trailing whitespace is allowed between fields.
- Double-quotes are only required if a field value contains a comma, or if the value must have leading/trailing whitespace.
- Multi-line text values are not supported. (ie. the **Comment** field must be a single line)

These rules help make the CSV file easy to edit in text editor, allowing you to visually align columns with extra spaces/tabs as needed.
But CSV files generated by your integration can completely omit any whitespace.

### CSV row rules

These rules apply to allow for flexible import scenarios:
- One file can contain data for multiple locations. This is useful for field visit data migration scenarios.
- Each row can contain a stage/discharge measurement, and/or 5 parameter readings. Any of those can be left blank.
- Rows for the same location and the same day are combined into a single uploaded visit for that day.
- The measurement time used for imported readings is the midpoint between the measurement start/end time.

### Header lines

A header line does not need to appear at all in the CSV file.
But if it does exist, it must exactly match line 5 in the [example file](#example-file) below.
The header line must be the 18 field names, listed in the order below, separated by commas. Whitespace between column names is ignored.

## CSV Fields

There are up to 33 fields in each row.

|FieldName|Datatype|Activity types|Required?|Description|
|---|---|---|---|
| **LocationIdentifier** | string | All | Y | The AQTS location identifier for the measurement.|
| **MeasurementId** | string | Discharge | N | An optional measurement ID for a discharge value. Measurement IDs must be unique per location.|
| **MeasurementStartDateTime** | DateTimeOffset | All | Y | The start time of the measurement. See the [Timestamps](#timestamps) section below for format details. |
| **MeasurementEndDateTime** | DateTimeOffset | All | Y | The end time of the measurement, which cannot be earlier than the start time.|
| **StageAtStart** | double | Discharge | Y | The stage value at the start of the measurement. |
| **StageAtEnd** | double | Discharge | Y | The stage value at the end of the measurement. |
| **StageUnits** | string | Discharge | Y | The units of the stage measurement. |
| **Discharge** | double | Discharge | Y | The measured discharge flow. |
| **DischargeUnits** | string | Discharge | Y | The units of the discharge measurement. |
| **ChannelName** | string | Discharge | Y | The name of the channel in which the measurment was taken. |
| **ChannelWidth** | double | Discharge | N | The width of the channel, measured in the same units as the stage values. If omitted, a value of zero will be used. |
| **WidthUnits** | string | Discharge | Y | The units of the channel width measurement. |
| **ChannelArea** | double | Discharge | N | The area of the channel. If omitted, a value of zero will be used. |
| **AreaUnits** | string | Discharge | Y | The units of the channel area measurement. |
| **ChannelVelocity** | double | Discharge | N | The average velocity of water in the channel. If omitted, a value of zero will be used. |
| **VelocityUnits** | string | Discharge | Y | The units of the channel velocity measurement. |
| **Party** | string | All | N | A brief description of the who performed the measurement. |
| **Comments** | string | All | N | Any other comments you wish to add to the measurements. |
| **Reading1Parameter** | string | Reading | Y | The parameter ID of reading 1. |
| **Reading1Units** | string | Reading | Y | The units of reading 1. |
| **Reading1Value** | double | Reading | Y | The numeric value of reading 1. |
| ... | ... | ... | ... | ... |
| **Reading5Parameter** | string | Reading | Y | The parameter ID of reading 5. |
| **Reading5Units** | string | Reading | Y | The units of reading 5. |
| **Reading5Value** | double | Reading | Y | The numeric value of reading 5. |

## The `Discharge` column defines the presence/absence of a discharge activity

- When the **Discharge** column is set to a value, the plugin will validate the other 13 Discharge-related columns.
- When the **Discharge** column is empty, the plugin will require all the other 13 Discharge-related columns to be empty.

## The `ReadingXValue` column defines the presence/absence of a parameter reading

- When the **Reading1Value** column is set to a value, the plugin will validate that the **Reading1Parameter** and **Reading1Units** columns are also set.
- When the **Reading1Value** column is empty, the plugin will require the other 2 columns to be empty.
- When readings exist in a CSV row, the timestamp used for the imported reading will be the mid-point between the **MeasurementStartDateTime** and **MeasurementEndDateTime** values.

## Timestamps

Timestamps are specified in ISO 8601 format. Specifically the `"O"` (roundtrip) format for .NET DateTimeOffset values is used.

`yyyy-MM-ddTHH:mm:ss.fffffffzzz`

- The `T` character must separate the date and time portions.
- All seven fractional seconds digits are optional. This 100 nanosecond precision is the full resolution supported by AQUARIUS Time-Series.
- The time-zone (`zzz`) portion can either be an explicit offset in hours/minutes (`+04:00` or `-00:30`) or it can be the UTC indicator of the letter `Z`.
- These constraints ensure that the timestamps contain no ambiguity.

See https://docs.microsoft.com/en-us/dotnet/standard/base-types/standard-date-and-time-format-strings#Roundtrip for more details.

## My parameter readings are being imported at weird times!

- Remember that readings are imported using a timestamp at the mid-point of the **MeasurementStartDateTime** and **MeasurementEndDateTime** values.
- If a row has a start time of noon, and an end time of 1 PM, and has a water temperature reading, the imported reading will have a timestamp of 12:30 PM.
- This allows one row to define a discharge activity and multiple parameter readings (like water temperature).
- When the mid-point convention is not appropriate for your readings, add the readings on a separate row, and set both the **MeasurementStartDateTime** and **MeasurementEndDateTime** values set to the same desired reading time.

## Example file

This example file contains 4 measurements at two different locations.
- Two of the measurements occur on different days in April 2016 at `LocationA`, and will create two separate field visits in AQTS.
- Two of the measurements occur on the same day in May 2017 at `LocationB`, and will create a single visit containing both measurements.
- The order of measurement rows in the CSV file does not matter. The parser will sort all the rows by location and time before creating any field visit records.

```
# A comment line
#
# AQUARIUS Stage-Discharge CSV v1.0
#
LocationIdentifier, MeasurementId, MeasurementStartDateTime,          MeasurementEndDateTime,            StageAtStart, StageAtEnd, StageUnits, Discharge, DischargeUnits, ChannelName, ChannelWidth, WidthUnits, ChannelArea, AreaUnits, ChannelVelocity, VelocityUnits, Party, Comments
LocationA         , 46791        , 2016-04-01T00:00:00.0000000Z,      2016-04-01T02:00:00.0000000Z,      12.0,         12.5,       ft,         32.3,      ft^3/s,         Main,        ,             ft,         ,            ft^2,      ,                ft/s
                                                                                                    
LocationB         ,              , 2017-05-01T03:00:00.0000000+04:00, 2017-05-01T04:00:00.0000000+04:00, 8.7,          8.6,        ft,         13.5,      ft^3/s,         Main,        ,             ft,         ,            ft^2,      ,                ft/s,          ,      "Bubbler hose was disturbed, so we remeasured"
LocationB         , 852345       , 2017-05-01T05:00:00.0000000+04:00, 2017-05-01T06:00:00.0000000+04:00, 9.4,          9.4,        ft,         13.6,      ft^3/s,         Main,        ,             ft,         ,            ft^2,      ,                ft/s
                                                                                                    
LocationA         , 46792        , 2016-04-02T03:00:00.0000000Z,      2016-04-02T04:00:00.0000000Z,      11.85,        12.7,       ft,        132.3,      ft^3/s,         Main,        23.4,         ft,         125.63,      ft^2,       85.2,           ft/s,          Doug , My oh my what a comment
```

The end result of importing this CSV file will be:

```
LocationA
  Visit on April 1 2016
    Meas ID 46971  32.30 ft^3/s at 12.125 ft
  Visit on April 2 2016
    Meas ID 46972  132.3 ft^3/s at 12.275 ft
LocationB
  Visit on May 1 2017
                   13.50 ft^3/s at 8.650 ft
    Meas ID 852345 13.60 ft^3/s at 9.400 ft
```

The measurement IDs will be visible in the Rating Development Toolbox of AQUARIUS Time-Series.


The example file above contains a fair bit of whitespace and comments to make the data more easy to ready in a text editor.
But all of that whitespace and comments is not needed.

The following CSV text is identical in content to the above file, but with every optional bit of text removed:
```
LocationA,46791,2016-04-01T00:00:00.0000000Z,2016-04-01T02:00:00.0000000Z,12.0,12.5,ft,32.3,ft^3/s,Main,,ft,,ft^2,,ft/s
LocationB,,2017-05-01T03:00:00.0000000+04:00,2017-05-01T04:00:00.0000000+04:00,8.7,8.6,ft,13.5,ft^3/s,Main,,ft,,ft^2,,ft/s,,"Bubbler hose was disturbed, so we remeasured"
LocationB,852345,2017-05-01T05:00:00.0000000+04:00,2017-05-01T06:00:00.0000000+04:00,9.4,9.4,ft,13.6,ft^3/s,Main,,ft,,ft^2,,ft/s
LocationA,46792,2016-04-02T03:00:00.0000000Z,2016-04-02T04:00:00.0000000Z,11.85,12.7,ft,132.3,ft^3/s,Main,23.4,ft,125.63,ft^2,85.2,ft/s,Doug,My oh my what a comment
```

## Building the plugin from source

You don't need to build the plugin yourself. You can simply download the `StageDischarge.plugin` file from the Releases page.

However, if you want to make changes or contributions, you will require a few free software development tools:
- Requires Visual Studio 2017 (Community Edition is fine)
- .NET 4.7 runtime
- Powershell 5+ [download it here](https://www.microsoft.com/en-us/download/details.aspx?id=54616) or install [via Chocolatey](https://chocolatey.org/packages/PowerShell): `choco install PowerShell`

## Building the plugin

- Load the `src\StageDischarge.sln` file in Visual Studio and build the `Release` configuration.
- The `deploy\Release\StageDischarge.plugin` file can then be installed on your AQTS app server.

## Testing the plugin within Visual Studio

Use the included `src\AqtsBinaries\Tester\PluginTester.exe` to test your plugin logic on the sample files.

1. Open the EhsnPlugin project's **Properties** page
2. Select the **Debug** tab
3. Select **Start external program:** as the start action and browse to `src\AqtsBinaries\Tester\PluginTester.exe`
4. Enter the **Command line arguments:** to launch your plugin

```
/Plugin=StageDischarge.dll /Json=AppendedResults.json /Data=..\..\..\..\data\sample.csv
```

The `/Plugin=` argument can be the filename of your plugin assembly, without any folder. The default working directory for a start action is the bin folder containing your plugin.

5. Set a breakpoint in the plugin's `ParseFile()` methods.
6. Select your plugin project in Solution Explorer and select **"Debug | Start new instance"**
7. Now you're debugging your plugin!

See the [PluginTester](https://github.com/AquaticInformatics/Examples/tree/master/TimeSeries/PublicApis/FieldDataPlugins/PluginTester) documentation for more details.
